/*                    
 * LeapJS Network - v0.1.0 - 2014-12-11                    
 * http://github.com/leapmotion/leapjs-network/                    
 *                    
 * Copyright 2014 LeapMotion, Inc                    
 *                    
 * Licensed under the Apache License, Version 2.0 (the "License");                    
 * you may not use this file except in compliance with the License.                    
 * You may obtain a copy of the License at                    
 *                    
 *     http://www.apache.org/licenses/LICENSE-2.0                    
 *                    
 * Unless required by applicable law or agreed to in writing, software                    
 * distributed under the License is distributed on an "AS IS" BASIS,                    
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                    
 * See the License for the specific language governing permissions and                    
 * limitations under the License.                    
 *                    
 */                    

(function(){"use strict";var a,b;a=function(){function a(){this.packingStructure=["id","timestamp","sentAt",{hands:[["id","type","direction","palmNormal","palmPosition","pinchStrength","grabStrength"]]},{pointables:[["id","direction","handId","length","tipPosition","carpPosition","mcpPosition","pipPosition","dipPosition","btipPosition","type"]]}]}return a.prototype.pack=function(a){return this.packData(this.packingStructure,a)},a.prototype.packData=function(a,b){var c,d,e,f,g,h,i,j;for(f=[],g=0,i=a.length;i>g;g++)if(e=a[g],"string"==typeof e)f.push(b[e]);else if("[object Array]"===Object.prototype.toString.call(e))for(h=0,j=b.length;j>h;h++)c=b[h],f.push(this.packData(e,c));else{for(d in e)break;f.push(this.packData(e[d],b[d]))}return f},a.prototype.unpack=function(a){return this.unpackData(this.packingStructure,a)},a.prototype.unpackData=function(a,b){var c,d,e,f,g,h,i,j,k,l;for(g={},d=i=0,k=a.length;k>i;d=++i)if(f=a[d],"string"==typeof f)g[f]=b[d];else{if("[object Array]"===Object.prototype.toString.call(f)){for(h=[],j=0,l=b.length;l>j;j++)c=b[j],h.push(this.unpackData(f,c));return h}for(e in f)break;g[e]=this.unpackData(f[e],b[d])}return g},a}(),b=function(){function a(a,b,c){var d;this.userId=b,this.controller=a,this.options=c,this.remoteFrames={},console.assert(this.userId),d=this,this.remoteFrameLoop=function(){var a,b;if(!this.controller.streaming())return b={hands:[],pointables:[]},d.addRemoteFrameData(b),a=new Leap.Frame(b),d.supplementFinishedFrame(a,b),this.controller.processFrame(a),window.requestAnimationFrame(d.remoteFrameLoop)}}return a.prototype.supplementLocalFrameData=function(a){var b,c,d,e,f,g,h,i,j;for(a.id+="-"+this.userId,a.sentAt=(new Date).getTime(),h=a.hands,d=0,f=h.length;f>d;d++)b=h[d],b.userId=this.userId,b.id+="-"+this.userId;for(i=a.pointables,j=[],e=0,g=i.length;g>e;e++)c=i[e],c.id+="-"+this.userId,j.push(c.handId+="-"+this.userId);return j},a.prototype.receiveRemoteFrame=function(a,b){var c;return c=this.remoteFrames[a],c&&c.timestamp>b.timestamp?void 0:(b.receivedAt=(new Date).getTime(),this.options.plotter&&this.plotFrameData(b,c),this.remoteFrames[a]=b)},a.prototype.plotFrameData=function(a,b){return this.options.plotter.plot("network latency",a.receivedAt-a.sentAt,{units:"ms",precision:3}),b&&this.options.plotter.plot("framerate (incoming)",1e3/(a.receivedAt-b.receivedAt),{units:"fps",precision:3}),this.options.plotter.clear(),this.options.plotter.draw()},a.prototype.addRemoteFrameData=function(a){var b,c,d,e,f,g,h,i,j;h=this.remoteFrames,j=[];for(e in h){if(d=h[e],(new Date).getTime()>d.sentAt+this.options.frozenHandTimeout){delete this.remoteFrames[e];break}for(i=d.hands,f=0,g=i.length;g>f;f++)b=i[f],a.hands.push(b);j.push(function(){var b,e,f,g;for(f=d.pointables,g=[],b=0,e=f.length;e>b;b++)c=f[b],g.push(a.pointables.push(c));return g}())}return j},a.prototype.supplementFinishedFrame=function(a,b){var c,d,e,f,g,h,i,j,k,l;for(j=a.hands,d=f=0,h=j.length;h>f;d=++f)c=j[d],c.id=b.hands[d].id,c.userId=b.hands[d].userId;for(k=a.pointables,l=[],d=g=0,i=k.length;i>g;d=++g)e=k[d],l.push(e.userId=b.pointables[d].userId);return l},a}(),Leap.plugin("networking",function(c){var d,e,f=this;return c.peer?(c.connection=null,c.sendFrames=!1,c.maxSendRate=60,c.frozenHandTimeout=250,e=null,c.framePacker=d=new a,c.peer.on("error",function(a){return console.log("peerjs error, not sending frames:",a,a.type),c.sendFrames=!1}),c.peer.on("connection",function(a){return console.log("incoming "+a.type+" connection from "+a.peer),c.connection=a,c.connectionEstablished()}),c.connect=function(a){return c.connection=c.peer.connect(a),console.log("outgoing "+c.connection.type+" connection to "+c.connection.peer),c.connectionEstablished()},c.connectionEstablished=function(){return c.sendFrames=!0,c.connection.on("data",function(a){var b;return a.frameData?(b=d.unpack(a.frameData),e.receiveRemoteFrame(c.connection.peer,b)):void 0})},c.peer.on("open",function(a){return console.log("Peer ID received: "+a),e=new b(f,a,c),setTimeout(function(){return e.remoteFrameLoop()},1e3)}),controller.on("streamingStopped",function(){return e?e.remoteFrameLoop():void 0}),c.lastFrame=null,c.shouldSendFrame=function(a){return c.lastFrame&&c.lastFrame.sentAt+c.maxSendRate>(new Date).getTime()?!1:c.lastFrame||0!==a.hands.length?c.lastFrame&&0===c.lastFrame.hands.length&&0===a.hands.length?!1:!0:!1},c.sendFrame=function(a){var b;if(c.shouldSendFrame(a))return b=c.connection.send({frameData:d.pack(a)}),c.plotter.plot("frame size (outgoing)",b.size/1024,{units:"kb",precision:3}),c.plotter.clear(),c.plotter.draw(),c.lastFrame=a},{beforeFrameCreated:function(a){return c.sendFrames?(e.supplementLocalFrameData(a),c.sendFrame(a),e.addRemoteFrameData(a)):void 0},afterFrameCreated:b.prototype.supplementFinishedFrame}):void console.warn("No Peer supplied")})}).call(this);